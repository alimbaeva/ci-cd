name: CI/CD Workflow

on:
  push:
    branches:
      - 'feature/*'  # –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –ø—É—à–µ–π –≤ –≤–µ—Ç–∫–∏, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å 'feature/'
  pull_request:
    branches:
      - 'main'  # –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è PR, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –≤ 'main'

jobs:
  # Job –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Install dependencies
        run: |
          npm ci  # –ò—Å–ø–æ–ª—å–∑—É–µ–º npm ci –¥–ª—è —á–∏—Å—Ç–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

      - name: Run tests
        run: |
          npm run test  # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏ –≤–µ—Ç–∫–∏ –∏ –∑–∞–ø—Ä–µ—Ç PR –∏–∑ test –≤ main
  check-branch-name:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Check branch name on push
        if: github.event_name == 'push'
        run: |
          branch_name=$(git symbolic-ref --short HEAD)
          echo "–¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $branch_name"
          if [[ ! "$branch_name" =~ ^feature/.* ]]; then
            echo "‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –≤–µ—Ç–∫–∏. –ò–º—è –≤–µ—Ç–∫–∏ –¥–æ–ª–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å 'feature/'"
            exit 1
          fi
          echo "‚úÖ –ò–º—è –≤–µ—Ç–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ: $branch_name"

      - name: Check source branch on pull request
        if: github.event_name == 'pull_request'
        run: |
          branch_name="${{ github.head_ref }}"
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ç–∫–∏: $branch_name"
          if [[ "$branch_name" == "test" ]]; then
            echo "‚ùå –û–¢–ö–ê–ó–ê–ù–û: –ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å PR –∏–∑ test –≤ main."
            exit 1
          fi
          echo "‚úÖ –í–µ—Ç–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞: $branch_name"


  # Job –¥–ª—è –¥–µ–ø–ª–æ—è
  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Deploy to production (–ø—Ä–∏–º–µ—Ä)
        run: |
          # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π –∫–æ–º–∞–Ω–¥—É –¥–ª—è –¥–µ–ø–ª–æ—è
          echo "–î–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..." 

  # Job –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏ –∏ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–≥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  release:
    needs: deploy
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Bump version and tag release
        run: |
          npm install standard-version --save-dev  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –≤–µ—Ä—Å–∏–∏
          npx standard-version  # –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é
          git push --follow-tags  # –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å —Ç–µ–≥–æ–º
